{% do craft.app.plugins.getPlugin('weglot').language.injectLanguagesJsonScript() %}
{% do craft.app.view.registerAssetBundle('weglot\\craftweglot\\resources\\AdminAsset') %}

{% import '_includes/forms.twig' as forms %}
{% set weglotPlugin = craft.app.plugins.getPlugin('weglot') %}

{% if not weglotPlugin %}
    <div class="warning">
        {{ "The Weglot plugin is not available."|t('weglot') }}
    </div>
{% endif %}

{{ forms.textField({
    label: 'API Key'|t('weglot'),
    instructions: 'Enter your Weglot API key.'|t('weglot'),
    id: 'apiKey',
    name: 'apiKey',
    value: settings.apiKey,
    errors: settings.getErrors('apiKey'),
    inputAttributes: {
        'data-weglot-api-key': true,
        'autocomplete': 'off'
    }
}) }}

{% if not settings.apiKey or settings.getErrors('apiKey') %}
    <div class="buttons" style="margin-top: 10px;">
        <a href="{{ craft.app.plugins.getPlugin('weglot').dashboardHelper.getRegistrationUrl() }}" class="btn" target="_blank" rel="noopener">{{ "Register on Weglot"|t('weglot') }}</a>
    </div>
{% endif %}

<div data-weglot-api-status style="margin-top: 10px;"></div>

{% set allLangEntries = weglotPlugin ? weglotPlugin.language.getAllLanguages() : [] %}
{% set languageOptions = [] %}
{% for lang in allLangEntries %}
    {% set code  = lang.getInternalCode() %}
    {% set label = lang.getEnglishName() ~ ' (' ~ lang.getLocalName() ~ ')' %}
    {% set languageOptions = languageOptions|merge([{ label: label, value: code }]) %}
{% endfor %}

{% set optionServiceLanguageFrom = weglotPlugin ? (weglotPlugin.option.getOption('language_from') ?? 'en') : 'en' %}
{% set languageFromValue = settings.languageFrom ?? optionServiceLanguageFrom %}

{% set osLangs = weglotPlugin ? (weglotPlugin.option.getOption('languages') ?? []) : [] %}
{% set defaultDestCodes = [] %}
{% for d in osLangs %}
    {% if d.language_to is defined and d.language_to %}
        {% set defaultDestCodes = defaultDestCodes|merge([d.language_to]) %}
    {% endif %}
{% endfor %}
{% set destValues = settings.languages is defined and settings.languages is not empty
    ? settings.languages
    : defaultDestCodes %}

{{ forms.selectField({
    label: 'Original Language'|t('weglot'),
    instructions: 'Choose the original language of the site.'|t('weglot'),
    id: 'languageFrom',
    name: 'languageFrom',
    options: languageOptions,
    value: languageFromValue
}) }}

{{ forms.textField({
    label: 'Destination Languages'|t('weglot'),
    id: 'languages',
    name: 'languages',
    value: (destValues ?? [])|join('|'),
    placeholder: 'fr|en|es',
    inputAttributes: { class: 'weglot-select-destination' }
}) }}

{% if settings.apiKey %}
    {% set dashboardHelper = craft.app.plugins.getPlugin('weglot').dashboardHelper %}
    {% if dashboardHelper %}
        {% set editUrl = dashboardHelper.getEditTranslationsUrl() %}
        {# Display buttons only if URLs could be generated #}
        {% if editUrl and editUrl != '#' %}
            <div class="weglot-dashboard-container">
                <h3>{{ "Quick access to Weglot dashboard"|t('weglot') }}</h3>
                <p>{{ "Manage your project directly on Weglot.com."|t('weglot') }}</p>
                <div class="buttons">
                    <a href="{{ editUrl }}" class="btn submit" target="_blank" rel="noopener">{{ "Edit my translations"|t('weglot') }}</a>
                    <a href="{{ dashboardHelper.getVisualEditorUrl() }}" class="btn" target="_blank" rel="noopener">{{ "Visual Editor"|t('weglot') }}</a>
                    <a href="{{ dashboardHelper.getManageUrlExclusionsUrl() }}" class="btn" target="_blank" rel="noopener">{{ "Manage URL Exclusions"|t('weglot') }}</a>
                    <a href="{{ dashboardHelper.getExcludeBlocksUrl() }}" class="btn" target="_blank" rel="noopener">{{ "Exclusion Blocks"|t('weglot') }}</a>
                </div>
            </div>
        {% endif %}
    {% endif %}
{% endif %}
