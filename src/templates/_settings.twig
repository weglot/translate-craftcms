{% do craft.app.plugins.getPlugin('weglot').language.injectLanguagesJsonScript() %}
{% do craft.app.view.registerAssetBundle('weglot\\craftweglot\\resources\\AdminAsset') %}
<h1>General</h1>
{% import '_includes/forms.twig' as forms %}
{% set weglotPlugin = craft.app.plugins.getPlugin('weglot') %}

{% if not weglotPlugin %}
    <div class="warning">
        {{ "The Weglot plugin is not available."|t('weglot') }}
    </div>
{% endif %}

{{ forms.textField({
    label: 'API Key'|t('weglot'),
    instructions: 'Enter your Weglot API key.'|t('weglot'),
    id: 'apiKey',
    name: 'apiKey',
    value: settings.apiKey,
    errors: settings.getErrors('apiKey'),
    inputAttributes: {
        'data-weglot-api-key': true,
        'autocomplete': 'off'
    }
}) }}

{% if not settings.apiKey or settings.getErrors('apiKey') %}
    <div class="buttons" style="margin-top: 10px;">
        <a href="{{ craft.app.plugins.getPlugin('weglot').dashboardHelper.getRegistrationUrl() }}" class="btn"
           target="_blank" rel="noopener">{{ "Register on Weglot"|t('weglot') }}</a>
    </div>
{% endif %}

<div class="error-message" data-weglot-api-status></div>

{% set allLangEntries = weglotPlugin ? weglotPlugin.language.getAllLanguages() : [] %}
{% set languageOptions = [] %}
{% for lang in allLangEntries %}
    {% set code  = lang.getInternalCode() %}
    {% set label = lang.getEnglishName() ~ ' (' ~ lang.getLocalName() ~ ')' %}
    {% set languageOptions = languageOptions|merge([{ label: label, value: code }]) %}
{% endfor %}

{% set optionServiceLanguageFrom = weglotPlugin ? (weglotPlugin.option.getOption('language_from') ?? 'en') : 'en' %}
{% set languageFromValue = settings.languageFrom ?? optionServiceLanguageFrom %}

{% set osLangs = weglotPlugin ? (weglotPlugin.option.getOption('languages') ?? []) : [] %}
{% set defaultDestCodes = [] %}
{% for d in osLangs %}
    {% if d.language_to is defined and d.language_to %}
        {% set defaultDestCodes = defaultDestCodes|merge([d.language_to]) %}
    {% endif %}
{% endfor %}
{% set destValues = settings.languages is defined and settings.languages is not empty
    ? settings.languages
    : defaultDestCodes %}

{{ forms.selectField({
    label: 'Original Language'|t('weglot'),
    instructions: 'Choose the original language of the site.'|t('weglot'),
    id: 'languageFrom',
    name: 'languageFrom',
    options: languageOptions,
    value: languageFromValue
}) }}

{{ forms.textField({
    label: 'Destination Languages'|t('weglot'),
    id: 'languages',
    name: 'languages',
    value: (destValues ?? [])|join('|'),
    placeholder: 'fr|en|es',
    inputAttributes: { class: 'weglot-select-destination' }
}) }}



{% if settings.apiKey %}
    {% set dashboardHelper = craft.app.plugins.getPlugin('weglot').dashboardHelper %}
    {% if dashboardHelper %}
        {% set editUrl = dashboardHelper.getEditTranslationsUrl() %}
        {% if editUrl and editUrl != '#' %}
            <div class="weglot-dashboard-container">
                <h1>{{ "Quick access to Weglot dashboard"|t('weglot') }}</h1>
                <a href="{{ editUrl }}" class="menu-card-link">
                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/pencils.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">Translation list</div>
                                <div class="card-desc">Edit translations</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>

                <a href="{{ dashboardHelper.getExcludeBlocksUrl() }}" class="menu-card-link">
                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/puzzle.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">Block exclusion</div>
                                <div class="card-desc">Choose blocks to exclude via css selector</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>


                <a href="{{ dashboardHelper.getManageUrlExclusionsUrl() }}" class="menu-card-link">

                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/rocket.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">URL exclusion</div>
                                <div class="card-desc">Choose words, pages or lang to exclude</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>

                <a href="{{ dashboardHelper.getVisualEditorUrl() }}" class="menu-card-link">

                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/laptop.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">Visual Editor</div>
                                <div class="card-desc">Custom easily your translations</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>

                <a href="{{ dashboardHelper.getSwitcherEditor() }}" class="menu-card-link">

                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/language.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">Switcher Editor</div>
                                <div class="card-desc">Custom easily your switcher(s)</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>

                <a href="{{ dashboardHelper.getLanguageModel() }}" class="menu-card-link">

                    <div class="menu-card">
                        <div class="card-top">
                            <img
                                src="{{ view.getAssetManager().getPublishedUrl('@weglot/craftweglot/resources/img/diamond.svg', true) }}"
                                width="32"
                                height="32"
                                alt=""/>
                            <div class="wrapper-card-text">
                                <div class="card-title">Language model</div>
                                <div class="card-desc">Personalize tone for better translations</div>
                            </div>
                        </div>
                        <span class="btn-link">Go to Dashboard</span>
                    </div>
                </a>

            </div>
        {% endif %}
    {% endif %}
    <h2>Dynamics</h2>

    {{ forms.lightswitchField({
        label: 'Enable dynamics'|t('weglot'),
        instructions: 'Injects Weglot in the <head> and enables dynamic translation. Inputs accept JSON or CSV (one selector per line).'|t('weglot'),
        id: 'enableDynamics',
        name: 'enableDynamics',
        on: settings.enableDynamics ?? false
    }) }}

{% endif %}
{% if showFirstSettingsPopup is defined and showFirstSettingsPopup %}
    <div id="weglot-box-first-settings" class="weglot-box-overlay" data-weglot-show-popup="true">
        <div class="weglot-box">
            <button type="button" class="weglot-btn-close" aria-label="{{ 'Close'|t('weglot') }}">
                <span aria-hidden="true">Ã—</span>
            </button>
            <h3 class="weglot-box--title">{{ 'Well done! Your website is now multilingual.'|t('weglot') }}</h3>
            <p class="weglot-box--text">{{ 'Go on your website, there is a language switcher bottom right. Try it :)'|t('weglot') }}</p>
            <a class="btn submit" href="{{ craft.app.sites.primarySite.baseUrl }}" target="_blank" rel="noopener">
                {{ 'Go on my front page.'|t('weglot') }}
            </a>
            <p class="weglot-box--subtext">{{ 'Next step, customize the language button as you want and manually edit your translations directly in your Weglot account.'|t('weglot') }}</p>
        </div>
    </div>
{% endif %}
