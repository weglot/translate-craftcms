name: Build & Scope

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]
    paths-ignore:
      - 'dependencies_scoped/**'   # avoid CI loops when the scoped directory is auto-committed
      - '.github/**'
  workflow_dispatch:                # allow manual runs from the Actions tab
  release:
    types: [ published ]            # guard: verify the scoped output exists in the release tag

jobs:
  scope-and-validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # fetch full history (some tools rely on it)

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2
          coverage: none

      - name: Install Composer deps
        run: composer install --no-interaction --prefer-dist --no-progress

      # === Recreate dependencies/ from your private repositories ===
      - name: Fetch vendor sources into dependencies/
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf dependencies
          mkdir -p dependencies

          git clone --depth 1 "https://${GH_TOKEN}:x-oauth-basic@github.com/weglot/weglot-php.git"        dependencies/weglot-php
          git clone --depth 1 "https://${GH_TOKEN}:x-oauth-basic@github.com/weglot/simple_html_dom.git"   dependencies/simplehtmldom
          git clone --depth 1 "https://${GH_TOKEN}:x-oauth-basic@github.com/weglot/weglot-translation-definitions.git" dependencies/translation-definitions

          # (Optional) pin a specific ref:
          # pushd dependencies/weglot-php && git fetch --depth 1 origin <sha-or-tag> && git checkout <sha-or-tag> && popd

      # Run Scoper + copy non-PHP assets (delegated to your Composer "scoper" script)
      - name: Run PHP-Scoper (prefix + copy assets)
        run: composer run scoper

      # Sanity checks: PHP syntax in the scoped output
      - name: Lint scoped PHP
        run: |
          find dependencies_scoped -type f -name "*.php" -print0 | xargs -0 -n1 php -l

      # Runtime smoke tests: ensure a scoped class and a namespaced function resolve
      - name: Runtime smoke tests
        run: |
          php -r "require 'vendor/autoload.php'; echo (class_exists('Weglot\\Vendor\\Weglot\\Client\\Client') ? \"OK\n\" : \"KO\n\");"
          php -r "require 'vendor/autoload.php'; echo (function_exists('Weglot\\Vendor\\WGSimpleHtmlDom\\str_get_html') ? \"OK\n\" : \"KO\n\");"

      # Auto-commit the scoped output if there are changes (only on push, not on PRs)
      - name: Commit scoped output if changed
        if: github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(scope): refresh dependencies_scoped [skip ci]"
          file_pattern: dependencies_scoped/**
          commit_user_name: Edson
          commit_user_email: edson@weglot.com
          skip_fetch: fals_
